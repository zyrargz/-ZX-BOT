const { default: makeWASocket, useMultiFileAuthState } = require("@whiskeysockets/baileys");
const fs = require("fs");
require("dotenv").config();

const sessionFolder = "auth";
const ownerNumber = "6287851745422@s.whatsapp.net";
const DB_FILE = "database.json";

function readDB() {
    if (!fs.existsSync(DB_FILE)) {
        fs.writeFileSync(DB_FILE, JSON.stringify({ premiumUsers: {}, bannedUsers: {}, userCoins: {}, gameSessions: {}, premiumExpiry: {}, airdrop: null }, null, 2));
    }
    return JSON.parse(fs.readFileSync(DB_FILE));
}

function saveDB(data) {
    fs.writeFileSync(DB_FILE, JSON.stringify(data, null, 2));
}

let db = readDB();
let { premiumUsers, bannedUsers, userCoins, gameSessions, premiumExpiry, airdrop } = db;
let airdropEnabled = true;

async function startBot() {
    try {
        const { state, saveCreds } = await useMultiFileAuthState(sessionFolder);
        const sock = makeWASocket({
            auth: state,
            printQRInTerminal: true,
        });

        sock.ev.on("creds.update", saveCreds);
        sock.ev.on("connection.update", (update) => {
            if (update.connection === "open") {
                console.log("âœ… ZX BOT berhasil terhubung!");
            }
        });

        sock.ev.on("messages.upsert", async (msg) => {
            try {
                const message = msg.messages[0];
                if (!message || !message.message) return;

                const isGroup = message.key.remoteJid.endsWith("@g.us");
                const sender = isGroup ? message.key.participant : message.key.remoteJid;
                const text = message.message.conversation || message.message.extendedTextMessage?.text || "";

                if (bannedUsers[sender]) return;

                const reply = async (content) => {
                    await sock.sendMessage(message.key.remoteJid, { text: content }, { quoted: message });
                };

                if (text === "!menu") {
                    const menuText = `
ğŸ“œ *ZX BOT MENU* ğŸ“œ
ğŸ‘‘ BOT MADE BY: Zyraxyro

ğŸ›  *Command Dasar*  
âš¡ !ping  
ğŸµ !ytmp3 [link]  
ğŸ“¹ !ytmp4 [link]  
ğŸ“¢ !tagall  

ğŸ† *Fitur Grup*  
ğŸšª !kick @user  
â• !add [nomor]  
ğŸ“¢ !tagall  

ğŸ® *Game Seru*  
ğŸ² !game  
ğŸ’° !steal @user  

ğŸ’¸ *Ekonomi*  
ğŸ !airdrop  
ğŸ¦ !me (Cek profil)  
ğŸ’³ !profile @user  

ğŸ”§ *Owner Only*  
ğŸ–¥ !ownermenu  
ğŸ”° *Admin Only*  
âš ï¸ !adminmenu  
ğŸ² *Random*  
ğŸ”® !random`;
                    reply(menuText);
                }

                if (text === "!game") {
                    const gameList = `ğŸ® *Daftar Game ZX BOT* ğŸ®
1ï¸âƒ£ !tebakangka
2ï¸âƒ£ !tebakkata
3ï¸âƒ£ !suit [batu/kertas/gunting]
4ï¸âƒ£ !tebakgambar
5ï¸âƒ£ !mathquiz
6ï¸âƒ£ !caklontong
7ï¸âƒ£ !tebakbendera
8ï¸âƒ£ !tictactoe @user
9ï¸âƒ£ !tebakkalimat
ğŸ”Ÿ !siapacepat`;
                    reply(gameList);
                }

                if (text.startsWith("!airdrop")) {
                    if (!airdrop || airdrop.claimed) return reply("âŒ Airdrop sudah diambil atau tidak tersedia!");
                    airdrop.claimed = sender;
                    userCoins[sender] = (userCoins[sender] || 0) + airdrop.amount;
                    saveDB(db);
                    reply(`ğŸ‰ Selamat! Kamu mendapatkan ${airdrop.amount}$ dari airdrop!`);
                }

                if (text.startsWith("!steal")) {
                    let target = text.split(" ")[1];
                    if (!target) return reply("âŒ Gunakan: !steal @user");
                    let stealAmount = Math.floor(Math.random() * 100) + 1;
                    let successChance = Math.random() * 100;
                    if (successChance > 50) {
                        userCoins[target] = Math.max(0, (userCoins[target] || 0) - stealAmount);
                        userCoins[sender] = (userCoins[sender] || 0) + stealAmount;
                        saveDB(db);
                        reply(`ğŸ­ Berhasil mencuri ${stealAmount}$ dari ${target}!`);
                    } else {
                        reply("âŒ Gagal mencuri!");
                    }
                }

                if (text.startsWith("!profile")) {
                    let target = text.split(" ")[1] || sender;
                    let coins = userCoins[target] || 0;
                    let premiumStatus = premiumUsers[target] ? "âœ… Premium" : "âŒ Biasa";
                    let expiry = premiumExpiry[target] || "-";
                    reply(`ğŸ‘¤ *Profil*
ğŸ“Œ User: ${target}
ğŸ’° Uang: ${coins}$
â­ Status Premium: ${premiumStatus}
ğŸ•’ Berlaku hingga: ${expiry}`);
                }

                if (text === "!me") {
                    let coins = userCoins[sender] || 0;
                    let premiumStatus = premiumUsers[sender] ? "âœ… Premium" : "âŒ Biasa";
                    let expiry = premiumExpiry[sender] || "-";
                    reply(`ğŸ‘¤ *Profil Kamu*
ğŸ’° Uang: ${coins}$
â­ Status Premium: ${premiumStatus}
ğŸ•’ Berlaku hingga: ${expiry}`);
                }
            } catch (err) {
                console.error("âŒ ERROR:", err);
            }
        });
    } catch (err) {
        console.error("âŒ Bot gagal dimulai:", err);
    }
}

startBot();
